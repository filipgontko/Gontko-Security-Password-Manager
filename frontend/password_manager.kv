#:import Clipboard kivy.core.clipboard.Clipboard

# Class representing the sign up form screen.
<Signup>:
    name: "signup"
    MDCard:
        size_hint: None, None
        size: 300, 400
        pos_hint: {"center_x": 0.5, "center_y": 0.5}
        elevation: 25
        padding: 25
        spacing: 25
        orientation: "vertical"

        MDLabel:
            id: welcome_label
            text: "Gontko Security"
            font_size: 20
            halign: "center"
            size_hint_y: None
            height: self.texture_size[1]
            padding_y: 10

        MDTextFieldRound:
            id: email
            hint_text: "e-mail"
            icon_right: "account"
            required: True
            size_hint_x: None
            width: 200
            font_size: 15
            pos_hint: {"center_x": 0.5}
            normal_color: app.theme_cls.accent_color

        MDTextFieldRound:
            id: password
            hint_text: "master password"
            icon_right: "eye-off"
            required: True
            size_hint_x: None
            width: 200
            font_size: 15
            pos_hint: {"center_x": 0.5}
            password: True
            normal_color: app.theme_cls.accent_color

        Widget:
            size_hint_y: None
            height: 5

        MDRoundFlatButton:
            text: "SIGN UP"
            font_size: 12
            pos_hint: {"center_x": 0.5}
            on_release:
                root.signup(email.text, password.text)
                email.text = ""
                password.text = ""
                app.root.current = "logged_in"
                root.manager.transition.direction = "left"

        Widget:
            size_hint_y: None
            height: 10

# Class representing the log in form screen.
<Login>:
    name: "login"
    MDCard:
        size_hint: None, None
        size: 300, 400
        pos_hint: {"center_x": 0.5, "center_y": 0.5}
        elevation: 25
        padding: 25
        spacing: 25
        orientation: "vertical"

        MDLabel:
            id: welcome_label
            text: "Gontko Security"
            font_size: 20
            halign: "center"
            size_hint_y: None
            height: self.texture_size[1]
            padding_y: 10

        MDTextFieldRound:
            id: email
            hint_text: "e-mail"
            icon_right: "account"
            required: True
            size_hint_x: None
            width: 200
            font_size: 15
            pos_hint: {"center_x": 0.5}
            normal_color: app.theme_cls.accent_color

        MDTextFieldRound:
            id: login_password
            hint_text: "master password"
            icon_right: "key"
            required: True
            size_hint_x: None
            width: 200
            font_size: 15
            pos_hint: {"center_x": 0.5}
            password: True
            normal_color: app.theme_cls.accent_color

        Widget:
            size_hint_y: None
            height: 5

        MDRoundFlatButton:
            text: "LOG IN"
            font_size: 12
            pos_hint: {"center_x": 0.5}
            on_release:
                root.login(email.text, login_password.text)
                root.manager.transition.direction = "left"
                email.text = ""
                login_password.text = ""

        MDRoundFlatButton:
            text: "FORGOT PASSWORD"
            font_size: 12
            pos_hint: {"center_x": 0.5}
            on_release: root.forgot_password()

        Widget:
            size_hint_y: None
            height: 10

# Class representing the logged in screen.
<LoggedIn>:
    name: "logged_in"
    MDBanner:
        id: banner
        text: ["Generated password has been copied to clipboard."]
        over_widget: logged_in_screen
        vertical_pad: toolbar.height
        left_action: ["CLOSE", lambda x: None]

    MDBoxLayout:
        orientation: "vertical"
        MDToolbar:
            id: toolbar
            title: "Gontko Security Password Manager"
            left_action_items: [["security", lambda x: app.navigation_draw()]]
            md_bg_color: app.theme_cls.primary_dark

            MDFillRoundFlatButton:
                text: "Log Out"
                font_size: 12
                pos_hint: {"center_x": 0.5, "center_y": 0.5}
                md_bg_color: app.theme_cls.primary_color
                on_release:
                    root.logout()
                    app.root.current = "login"
                    root.manager.transition.direction = "right"

        # Grid layout to split the screen into two columns.
        MDGridLayout:
            id: logged_in_screen
            cols: 2
            md_bg_color: app.theme_cls.primary_color
            spacing: 10
            padding: 10

            MDCard:
                orientation: "vertical"
                size: root.width, root.height

                # The search bar with magnify icon is this whole MDBoxLayout
                MDBoxLayout:
                    id: search_bar
                    adaptive_height: True

                    MDIconButton:
                        icon: "magnify"

                    MDTextField:
                        id: search_field
                        hint_text: "Search credentials"
                        on_text: root.set_list_credentials(self.text, True)

                # RecycleView is used for the adaptive adding and showing of credentials to scroll-down list
                RecycleView:
                    id: rv
                    key_viewclass: "viewclass"
                    key_size: "height"

                    RecycleBoxLayout:
                        padding: dp(10)
                        default_size: None, dp(60)
                        default_size_hint: 1, None
                        size_hint_y: None
                        height: self.minimum_height
                        orientation: "vertical"

            MDCard:
                orientation: "vertical"
                size: root.width, root.height
                spacing: 15
                padding: 40
                MDTextField:
                    id: username
                    icon_right: "account"
                    mode: "fill"
                    hint_text: "username"
                    size_hint_x: None
                    width: 300
                    font_size: 15
                    pos_hint: {"center_x": 0.5}

                # MDRelativeLayout allows to set relative position for the children. The icon can be in the text field
                MDRelativeLayout:
                    size_hint_y: None
                    height: passwd.height
                    size_hint_x: None
                    width: "300dp"
                    pos_hint: {"center_x": .5, "center_y": .5}
                    MDTextField:
                        id: passwd
                        mode: "fill"
                        hint_text: "password"
                        size_hint_x: None
                        width: 300
                        font_size: 15
                        pos_hint: {"center_x": 0.5}
                        password: True

                    MDIconButton:
                        icon: "eye-off"
                        pos_hint: {"center_y": .5}
                        pos: passwd.width - self.width + dp(4), 0
                        theme_text_color: "Custom"
                        text_color: 0, 0, 0, 0.5
                        on_release:
                            self.icon = "eye" if self.icon == "eye-off" else "eye-off"
                            passwd.password = False if passwd.password is True else True

                MDTextField:
                    id: website
                    icon_right: "web"
                    hint_text: "website"
                    size_hint_x: None
                    width: 295
                    font_size: 15
                    pos_hint: {"center_x": 0.5}

                MDFillRoundFlatButton:
                    text: "Add Credentials"
                    font_size: 12
                    pos_hint: {"center_x": 0.5}
                    on_release:
                        root.add_credentials(website.text, username.text, passwd.text)
                        website.text = ""
                        username.text = ""
                        passwd.text = ""
                        generate_pwd.text = ""

                Widget:
                    size_hint_y: None
                    height: 2

                MDTextFieldRect:
                    id: generate_pwd
                    size_hint_y: None
                    height: "30dp"

                MDSlider:
                    id: strength_slider
                    min: 12
                    max: 32
                    step: 1
                    size_hint_y: None
                    size: sp(32), sp(32)
                    color: app.theme_cls.accent_dark

                MDFillRoundFlatButton:
                    text: "Generate Password"
                    font_size: 12
                    pos_hint: {"center_x": 0.5}
                    on_release:
                        generate_pwd.text = root.generate_password(strength_slider.value)
                        Clipboard.copy(generate_pwd.text)
                        banner.show()

                Widget:
                    size_hint_y: None
                    height: 1

<CredentialsView>
    name: "creds_view"

    MDBanner:
        id: banner
        text: ["Generated password has been copied to clipboard."]
        over_widget: grid
        vertical_pad: toolbar.height
        left_action: ["CLOSE", lambda x: None]

    MDBoxLayout:
        orientation: "vertical"
        MDToolbar:
            id: toolbar
            title: "Gontko Security Password Manager"
            left_action_items: [["security", lambda x: app.navigation_draw()]]
            md_bg_color: app.theme_cls.primary_dark

            MDFillRoundFlatButton:
                text: "Go Back"
                font_size: 12
                pos_hint: {"center_x": 0.5, "center_y": 0.5}
                on_release:
                    app.root.current = "logged_in"
                    root.manager.transition.direction = "right"

        MDGridLayout:
            id: grid
            cols: 2
            md_bg_color: app.theme_cls.primary_color
            spacing: 10
            padding: 10

            # Left side of the screen
            MDCard:
                orientation: "vertical"
                size: root.width, root.height
                padding: 10
                spacing: 15

                MDTextField:
                    id: username
                    icon_right: "account"
                    mode: "fill"
                    hint_text: "username"
                    size_hint_x: None
                    width: 300
                    font_size: 15
                    pos_hint: {"center_x": 0.5}

                # MDRelativeLayout allows to set relative position for the children. The icon can be in the text field
                MDRelativeLayout:
                    size_hint_y: None
                    height: passwd.height
                    size_hint_x: None
                    width: "300dp"
                    pos_hint: {"center_x": .5, "center_y": .5}
                    MDTextField:
                        id: passwd
                        mode: "fill"
                        hint_text: "password"
                        size_hint_x: None
                        width: 300
                        font_size: 15
                        pos_hint: {"center_x": 0.5}
                        password: True
                        on_focus: root.show_password_strength()

                    MDIconButton:
                        icon: "eye-off"
                        pos_hint: {"center_y": .5}
                        pos: passwd.width - self.width + dp(4), 0
                        theme_text_color: "Custom"
                        text_color: 0, 0, 0, 0.5
                        on_release:
                            self.icon = "eye" if self.icon == "eye-off" else "eye-off"
                            passwd.password = False if passwd.password is True else True

                Widget:
                    size_hint_y: None
                    height: 20

                MDTextField:
                    id: website
                    icon_right: "web"
                    hint_text: "website"
                    size_hint_x: None
                    width: 295
                    font_size: 15
                    pos_hint: {"center_x": 0.5}

                Widget:
                    size_hint_y: None
                    height: 10

                MDBoxLayout:
                    orientation: "horizontal"
                    size_hint: None, None
                    size: 290,80
                    pos_hint: {"center_x": 0.5, "center_y": 0.5}
                    padding: 45
                    spacing: 25

                    MDRoundFlatButton:
                        text: "Delete"
                        font_size: 12
                        on_release: root.show_dialog("delete")

                    MDFillRoundFlatButton:
                        text: "Save"
                        font_size: 12
                        on_release: root.show_dialog("save")
                Widget:
                    size_hint_y: None
                    height: 20

            # Right side of the screen
            MDCard:
                orientation: "vertical"
                size: root.width, root.height
                padding: 40
                spacing: 15

                MDLabel:
                    text: "Password Strength"
                    font_size: 20
                    halign: "center"
                    size_hint_y: None
                    height: self.texture_size[1]

                MDProgressBar:
                    id: strength_meter
                    size_hint_y: None
                    height: 10
                    value: 0
                    color: app.theme_cls.accent_color

                MDLabel:
                    id: strength_word
                    font_size: 15
                    text: ""
                    size_hint_y: None
                    height: 10

                Widget:
                    size_hint_y: None
                    height: 30

                MDLabel:
                    text: "Password Generator"
                    font_size: 20
                    halign: "center"
                    size_hint_y: None
                    height: self.texture_size[1]

                MDTextFieldRect:
                    id: generate_pwd
                    size_hint_y: None
                    height: "30dp"

                MDSlider:
                    id: strength_slider
                    min: 12
                    max: 32
                    step: 1
                    size_hint_y: None
                    size: sp(32), sp(32)
                    color: app.theme_cls.accent_dark

                MDFillRoundFlatButton:
                    text: "Generate Password"
                    font_size: 12
                    pos_hint: {"center_x": 0.5}
                    on_release:
                        generate_pwd.text = root.generate_password(strength_slider.value)
                        Clipboard.copy(generate_pwd.text)
                        banner.show()

                Widget:
                    size_hint_y: None
                    height: 35